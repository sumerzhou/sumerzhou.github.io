<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>nodejs爬虫小程序|sumerzhou's blog</title>
    <link href="myblog.css" rel="stylesheet" type="text/css">
    <script src="myblog.js" type="text/javascript"></script>
    <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <style>
        .textBox{
            width: 980px;
            border-radius: 20px;
            position: relative;
            padding: 10px;
            top: 105px;
            line-height: 2em;
        }
        .textBox h2{
            margin-top: 10px;
            text-indent: 2em;
            text-shadow: 2px 2px 1px dodgerblue;
        }
        .textBox h3{
            margin-top: 10px;
            border-bottom:1px solid lightblue;
            box-shadow: 2px 2px 1px black;
        }
        .textBox h4{
            text-shadow: 1px 1px 2px #4F68B0;
        }
        .textBox p{
            text-indent: 2em;
        }
        .textBox li{
            text-indent: 2em;
            list-style: none;
        }
        .textBox pre{
            display: block;
            width: 850px;
            border-left: 1px solid black;
            border-right: 1px solid black;
            box-shadow: 4px 3px 2px black;
            padding-left: 30px;
            position: relative;
            left: -30px;
            font-family: '仿宋';
            background-color: rgb(40,44,52);
            line-height: 1.5;
            font-size: 15px;
            color:white;
            overflow-y: auto;
        }
        .highlight{
            background-color: rgb(255,243,212);
        }
    </style>
</head>
<body>
<!--header-->
<div class="headerbox">
    <div class="headertop">
        <div class="hdtopbut">
            <a href="http://blog.hungking.cc/" target="_blank"><img src="imgs/sns_blog_off.png"></a>
            <a href="https://www.facebook.com/HoungkingHsi" target="_blank"><img src="imgs/sns_facebook_off.png"></a>
            <a href="http://globalblog.hungking.cc/" target="_blank"><img src="imgs/sns_gBlog_off.png"></a>
            <a href="http://www.linkedin.com/imisslovelove" target="_blank"><img src="imgs/sns_in_off.png"></a>
            <a href="http://www.youtube.com/imisslovelove" target="_blank"><img src="imgs/sns_youTube_off.png"></a>
            <a href="http://www.instagram.com/imisslovelove" target="_blank"><img src="imgs/sns_instagram_off.png"></a>
            <a href="http://story.kakao.com/ch/imisslovelove" target="_blank" style="background: transparent none;"><img src="imgs/sns_kakao_off.png"></a>
            <div class="hdtopbutR">
                <a href="construction.html" style="background-position-x:85px ;">Contact Me</a>
                <a href="construction.html">AboutSite</a>
                <span onclick="ifshow(0)">Language<img src="imgs/btn_globalSite_open.gif"></span>
                <ul id="lag">
                    <li>KOREAN</li><li>CHINESE</li><li>JAPANESE</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="headerbotm">
        <a class="logohome" href="http://www.hungking.cc/company"><img src="imgs/blog.png"></a>
        <ul id="hdbotmUl">
            <li>
                <a href="company.html">WEB前端</a>
                <ul class="ultext1">
                    <li>
                        <a href="">HTML</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Corporate Overview</a></li>
                                <li><a href="">Vision of houngking</a></li>
                                <li><a href="">History of houngking</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">CSS/CSS3</a>
                        <div class="ultext2">
                            <ul>
                                <li><a>Brand Story</a></li>
                                <li><a>CI</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">JavaScript</a>
                        <div class="ultext2">
                            <ul>
                                <li><a>Greetings</a></li>
                                <li><a>CEO's Message</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Ajax</a>
                        <div class="ultext2">
                            <ul>
                                <li><a>hougking Affiliates</a></li>
                                <li><a>Steel</a></li>
                                <li><a>E&C</a></li>
                                <li><a>Trade</a></li>
                                <li><a>ICT</a></li>
                                <li><a>Energy</a></li>
                                <li><a>Material-Chemistry</a></li>
                                <li><a>Support</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">jQuery</a>
                        <div class="ultext2">
                            <ul>
                                <li><a>Global</a></li>
                                <li><a>Asia</a></li>
                                <li><a>America</a></li>
                                <li><a>Europe&Africa</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
            <li>
                <a href="company.html">Business Ethics</a>
                <ul class="ultext1">
                    <li>
                        <a href="">Code of Ethics</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">CEO Message</a></li>
                                <li><a href="">Ethics Charter</a></li>
                                <li><a href="">Practice Guidelines</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Major Activities</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Operation of the Ethical Management System</a></li>
                                <li><a href="">Education on Corporate Ethics</a></li>
                                <li><a href="">Unethical Act Prevention System</a></li>
                                <li><a href="">External Activities and Results</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
            <li>
                <a href="company.html">Products/Technology</a>
                <ul class="ultext1">
                    <li>
                        <a href="">Products of hounking</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Hot Rolled Steel</a></li>
                                <li><a href="">Steel Plate</a></li>
                                <li><a href="">Winter Day</a></li>
                                <li><a href="">Gold Rolled Steel</a></li>
                                <li><a href="">Galvanized Steel</a></li>
                                <li><a href="">Electrical Galvanized</a></li>
                                <li><a href="">Electrical Steel</a></li>
                                <li><a href="">Automotive materials</a></li>
                                <li><a href="">Stainless Steel</a></li>
                                <li><a href="">Titanium Product</a></li>
                                <li><a href="">Magnesium Product</a></li>
                                <li><a href="">Aluminum-plated products</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">houngking Technology</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">FINEX Technology</a></li>
                                <li><a href="">Strip Casting</a></li>
                                <li><a href="">Endless Hot Rolling Technology</a></li>
                                <li><a href="">Operation Technology</a></li>
                                <li><a href="">CEM Technology</a></li>
                            </ul>
                        </div>
                    </li>
                    <li style="background-image: none;">
                        <a href="">Production Process</a>
                    </li>
                    <li>
                        <a href="">Sales information</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">e-Sales</a></li>
                                <li><a href="">e-Procurement</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
            <li>
                <a href="company.html">Investor Relations</a>
                <ul class="ultext1">
                    <li style="background-image: none;">
                        <a href="">IR Activeties</a>
                    </li>
                    <li>
                        <a href="">Stock Information</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Stock Price</a></li>
                                <li><a href="">Price Comparision</a></li>
                                <li><a href="">ADR</a></li>
                                <li><a href="">houngking Stock Exchange</a></li>
                                <li><a href="">Economic Trend</a></li>
                                <li><a href="">Shareholders Demographics</a></li>
                                <li><a href="">Dividend</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Financial Information</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Income Statement</a></li>
                                <li><a href="">Credit Rating</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">IR Archive</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Audit Report</a></li>
                                <li><a href="">Form 20-F</a></li>
                                <li><a href="">Annual Report</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
            <li>
                <a href="company.html">Sustainability</a>
                <ul class="ultext1">
                    <li>
                        <a href="">Sustainability Management System</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Sustainability Management System</a></li>
                                <li><a href="">houngking Subsidiaries CSR Assessment</a></li>
                                <li><a href="">Risk Management</a></li>
                                <li><a href="">Stakeholder</a></li>
                                <li><a href="">Relevant Institutes Activities</a></li>
                            </ul>
                        </div>
                    </li>
                    <li style="background-image: none;">
                        <a href="">Social Responsibility </a>
                    </li>
                    <li>
                        <a href="">Environmental Management </a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Family's Environmental Management</a></li>
                                <li><a href="">Environmental Management</a></li>
                                <li><a href="">Climate change /Energy</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Customer</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Marketing strategy</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Employee</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Employee Health / Safety</a></li>
                                <li><a href="">Organizational Culture</a></li>
                                <li><a href="">HR system</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Report</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Sustainability Report</a></li>
                                <li><a href="">Carbon Report</a></li>
                                <li><a href="">Conflict Minerals Disclosure</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
            <li>
                <a href="company.html">PR Room</a>
                <ul class="ultext1">
                    <li style="background-image: none;">
                        <a href="">News room</a>
                    </li>
                    <li style="background-image: none;">
                        <a href="">News letter</a>
                    </li>
                    <li style="background-image: none;">
                        <a href="">houngking SNS</a>
                    </li>
                    <li>
                        <a href="">PR Archives</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Digital Brochure</a></li>
                                <li><a href="">TV Cormmercials</a></li>
                                <li><a href="">Screen Saver</a></li>
                                <li><a href="">PR Movies</a></li>
                                <li><a href="">Printed Advertisement</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Download</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Company</a></li>
                                <li><a href="">Products/Technology</a></li>
                                <li><a href="">Investor Relations</a></li>
                                <li><a href="">Sustainability</a></li>
                                <li><a href="">PR Room</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
        </ul>
        <img src="imgs/btn_gnb.png" class="imgbtn" id="imgbtn" onclick="ifshow(1)">
        <img src="imgs/btn_search.png" class="imgbtn2" onclick="ifshow(2)">
        <div class="hdmenu" id="hdmenu">
            <a href="">Open submenu</a>
            <ul class="menutxt1">
                <li>
                    <a href="">Company</a>
                    <ul>
                        <li><a href="">Corporate Overview</a></li>
                        <li><a href="">Brand</a></li>
                        <li><a href="">CEO</a></li>
                        <li><a href="">hounking Affiliates</a></li>
                        <li><a href="">hounking Overseas</a></li>
                    </ul>
                </li>
                <li>
                    <a href="">Business Ethics</a>
                    <ul>
                        <li><a href="">Code of Ethics</a></li>
                        <li><a href="">Major Activities</a></li>
                    </ul>
                </li>
                <li>
                    <a href="">Products/Technology</a>
                    <ul>
                        <li><a href="">Products of houngking</a></li>
                        <li><a href="">hounking Technology</a></li>
                        <li><a href="">Production Process</a></li>
                        <li><a href="">Sales informtion</a></li>
                    </ul>
                </li>
                <li style="padding: 0px;">
                    <a href="">Investor Relations</a>
                    <ul>
                        <li><a href="">IR Activities</a></li>
                        <li><a href="">Stock Information</a></li>
                        <li><a href="">Financial Information</a></li>
                        <li><a href="">IR Archive</a></li>
                    </ul>
                </li>
                <li>
                    <a href="">Sustainability</a>
                    <ul>
                        <li><a href="">Suatainability Management System</a></li>
                        <li><a href="">Social Redponsibility</a></li>
                        <li><a href="">Environmental Management</a></li>
                        <li><a href="">Customer</a></li>
                        <li><a href="">Employee</a></li>
                        <li><a href="">Report</a></li>
                    </ul>
                </li>
                <li>
                    <a href="">PR Room</a>
                    <ul>
                        <li><a href="">Newsroom</a></li>
                        <li><a href="">Newsletter</a></li>
                        <li><a href="">houngking SNS</a></li>
                        <li><a href="">PR Archives</a></li>
                        <li><a href="">Download</a></li>
                    </ul>
                </li>
                <li>
                    <a href="">Contact Us</a>
                    <ul>
                        <li><a href="">Q&A</a></li>
                        <li><a href="">Search</a></li>
                        <li><a href="">Location</a></li>
                        <li><a href="">Sitemap</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</div>
<!--text-->
<div class="textBox">
    <h2>nodejs爬虫小程序</h2>
    <h3>1,爬虫 & 反爬虫</h3>
    <h5>爬虫：</h5>
    <p>按照一定规则自动抓取网络信息的程序。搜索引擎其实就是一个非常大的爬虫。</p>
    <h5>反爬虫规则：</h5>
    <p>● User-Agent,Referer,验证码。爬虫用的User-Agent并不是正常浏览器的User-Agent，虽然这个实际上也可以伪造。如果查看到User-Agent是爬虫的话，可以拒绝对方访问，不提供真实内容或是引导到其他站点。或是用验证码，比方说12306，不能让机器来抢票，要求用户输入验证码。</p>
    <p>● 单位时间访问次数、访问量。因为用了爬虫，是程序在跑，肯定比正常人浏览要快得多，监测到这种行为，就限制访问了。</p>
    <p>● 关键信息的图片混淆。比如说电影评分网站，爬虫来抓取内容，用户就可以不用进该网站了，为了防止爬虫抓取到评分，就用图片来代替文字信息。</p>
    <p>● 异步加载。大部分爬虫的原理是，爬到网页后下载，并分析网页内容。它是一次HTTP请求，拿到HTML本身。如果这时候返回一个几乎是空的HTML，没有核心内容，核心内容是要用javascript异步加载，用户使用浏览器观看是没有问题的，但对于很多爬虫就处理不了，它抓到的几乎就是一个空壳。</p>
    <h3>2,案例项目--headless爬虫</h3>
    <p>写一个爬虫，爬一下百度上的图片，存到本地。这会触发百度的反爬虫规则，我们需要做一些反反爬虫的技巧，作一个粗浅的了解。</p>
    <p>网上可以搜到很多用nodejs写的爬虫的例子，很多都是用superAgent+cheerio库实现的。superAgent是帮我们发送请求得到HTML；cheerio有一个很强的功能是把HTML转换成一个像jQuery一样的对象，我们可以通过jQuery的一些方法获取信息。</p>
    <p>这里并不使用cheerio,因为它无法绕过反爬虫规则，拿到的HTML上可能什么都没有，信息可能是js异步加载实现的或者是懒加载随用户滚动加载新内容 。所以，需要模拟用户浏览，拿到全部的信息。不要使用webdriver，它的API太难读，使用很麻烦，但思路是对的。我们使用一个好用点的API，Googlechrome团队的puppeteer，它是一个headless Chrome Node API。但webdriver相对于puppeteer有一个非常强的优势，它可以驱动chrome、IE、Firefox等，而puppeteer仅仅是做headless chrome的。</p>
    <h4>puppeteer:</h4>
    <p>Puppeteer正如其名“木偶”，它允许我们像牵线木偶一样操纵它。它是一个建立在DevTools协议上的提供控制无头Chrome或Chromium的高级接口的Node库。官网上对其应用举了几个例子：</p>
    <p>- 生成网页的截屏（目前仅支持支持jpeg、png格式）和pdf文件</p>
    <p>- 爬取SPA和异步渲染网页 </p>
    <p>- 自动表单提交、键盘输入、UI测试等</p>
    <p>- 创建最新的自动测试环境，也就是说可以使用最新的浏览器特性 </p>
    <p>- 捕获站点的时间线以帮助分析性能问题</p>
    <p>puppeteer的使用很简单，API封装的也出色。几乎所有的操作都是异步的。</p>
    <h5>API:</h5>
    <p>setViewport(): 实例化时修改page size</p>
    <p>screenshot(): 截屏</p>
    <p>pdf(): 创建pdf</p>
    <p>evaluate(): 有些puppeteer没有包裹的API，可以使用evaluate()包裹起来，里面可以执行chrome的command line里的API。相当于除了使用包裹好的API，还可以使用原生的API。</p>
    <h4>爬虫代码实现:</h4>
    <h5>puppeteer安装(Windows):</h5>
    <p>Puppeteer会绑定最新版本的Chromium，这意味着每次使用npm i puppeteer安装使用它时都会下载最新版本的Chromium，该版本在Windows上大约是130Mb。本来下载npm包就很不易，还要下载一个一百多兆的东西更是难上加难了。</p>
    <p>而且由于封网，直接下载 Chromium 会失败。能不下载Chromium就尽量不下载了吧。</p>
    <p>官网讲到可以通过设置环境变量或配置npm config的方式避免下载。配置npm config的方式:</p>
    <pre>set PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=1 </pre>
    <p>虽然跳过下载的事情解决了，但是因为没有下载会导致puppeteer无法得知要使用的Chrome或Chromium在哪里，所以还需要指明启动路径。更改executablePath参数指向你本地chrome所在目录，注意一定要指向chrome.exe才能正常使用。headless参数也是挺有趣的，如果其值为false，就会真的为我们启动一个chrome进程，让我们可以可视化整个程序运行的过程。</p>
    <h5>代码 :</h5>
    <pre style="margin-bottom: 10px;">// package.json
{
  "name": "crawler",
  "version": "1.0.0",
  "description": "crawler demo",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "dina",
  "license": "ISC",
  "dependencies": {
    "puppeteer": "^1.9.0"
  }
}</pre>
    <pre style="height: 500px;margin-bottom: 10px;">// src/mn.js
const puppeteer = require('puppeteer');
const { mn } = require('./config/default');
const srcToImg = require('./helper/srcToImg');

(async () => {
    const browser = await puppeteer.launch({
        executablePath:'C:/Program Files (x86)/Google/Chrome/Application/chrome.exe',
        timeout: 50000,
        headless: false
    });
    const page = await browser.newPage();
    await page.goto('https://image.baidu.com/');
    console.log('go to https://image.baidu.com/');

    await page.setViewport({
        width:1920,
        height:1080
    });
    console.log('reset viewport');

    /* 截取图片
    await page.screenshot({path: `${mn}/example.png`});*/

    await page.focus('input#kw');
    await page.keyboard.sendCharacter('狗');
    console.log('test...');
    await page.click('.s_search');
    console.log('go to search list');

    page.on('load',async () => {
        console.log('page loading done,start fetch...');

        const srcs = await page.evaluate(() => {
            const images = document.querySelectorAll('img.main_img');
            return Array.prototype.map.call(images, img => img.src);
        });

        srcs.forEach(async src => {
            await srcToImg(src,mn);
        });
        await browser.close();
    });
})();

process.on('unhandledRejection', error => {
    console.log('unhandledRejection:', error.message);
});  </pre>
    <pre style="margin-bottom: 10px;">// src/config/default.js
const path = require('path');
module.exports = {
    mn: path.resolve(__dirname, '../../mn')
};</pre>
    <pre>// src/helper/srcToImg.js
module.exports = (src,dir) => {
    console.log(src);
} </pre>

    <h3>3,总结</h3>
    <h5>nodejs关键技术：</h5>
    <p>Stream：node的核心。nodejs最常用的两个模块http和fs全都是依赖Stream。</p>
    <p>动态的web framework：在大公司做nodejs相关的生产实践时，还经常会用它做线上渲染的server，就是动态的web framework。业界有很多杰出的代表，像express、koa .</p>
    <p>child_process & cluster:保障线上使用集群的。说nodejs是单进程单线程的，如何最大限度利用CPU，保证稳定性呢？可以了解一下.</p>
    <h5>深入学习：</h5>
    <p>· through2 :处理transform stream的，尤其在做本地代码构建，使用是相当频繁的。</p>
    <p>· express、koa、egg</p>
    <p>· SSR & 同构：大公司相当流行的概念。统一了前后端的编程体验。SSR，在服务器端渲染。同构，一套代码可以在浏览器端跑也可以在服务器端跑，服务器渲染失败了，可以在浏览器中跑。react和vue本身都有了SSR的能力。SSR在经过简单的包装，在代码构建的时候，构建出两份，一份针对服务器端，一份针对浏览器端的，再进行一些相关的配合，就可以做到同构。</p>
    <p>· nodejs源码：可以读一下用js写的相关部分。了解下它的书写风格，可以学习到很多东西。</p>


    <br/>
    <h5>参考文档:</h5>
    <a href="https://blog.csdn.net/sjn0503/article/details/54409584" target="_blank">从0到1学nodejs爬虫小程序</a>,<br>
    <a href="https://www.cnblogs.com/mafeng/p/5651323.html" target="_blank">网络爬虫技术</a>,<br>
    <a href="https://www.jianshu.com/p/a9a55c03f768" target="_blank">爬虫利器 Puppeteer 实战</a>, <br>
    <a href="https://www.jb51.net/article/138391.htm" target="_blank">详解Node使用Puppeteer完成一次复杂的爬虫</a> , <br>
    <a href="https://blog.csdn.net/fengxiaoxiao_1/article/details/80141588" target="_blank">Node爬虫神器Puppeteer安装记（Windows）</a>,<br>
    <a href="https://objcer.com/2017/12/27/unhandled-promise-rejections-in-node-js/" target="_blank">Node.js 中的 UnhandledPromiseRejectionWarning 问题</a>,<br>

</div>

</body>
</html>