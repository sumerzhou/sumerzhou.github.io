<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>使用Fetch & Fetch API|sumerzhou's blog</title>
    <link href="myblog.css" rel="stylesheet" type="text/css">
    <script src="myblog.js" type="text/javascript"></script>
    <script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <style>
        .textBox{
            width: 980px;
            border-radius: 20px;
            position: relative;
            padding: 10px;
            top: 105px;
            line-height: 2em;
        }
        .textBox h2{
            margin-top: 10px;
            text-indent: 2em;
            text-shadow: 2px 2px 1px dodgerblue;
        }
        .textBox h3{
            margin-top: 10px;
            border-bottom:1px solid lightblue;
            box-shadow: 2px 2px 1px black;
        }
        .textBox h4{
            text-shadow: 1px 1px 2px #4F68B0;
        }
        .textBox p{
            text-indent: 2em;
        }
        .textBox li{
            text-indent: 2em;
            list-style: none;
        }
        .textBox pre{
            display: block;
            width: 850px;
            border-left: 1px solid black;
            border-right: 1px solid black;
            box-shadow: 4px 3px 2px black;
            padding-left: 30px;
            position: relative;
            left: -30px;
            font-family: '仿宋';
            background-color: rgb(40,44,52);
            line-height: 1.5;
            font-size: 15px;
            color:white;
            overflow-y: auto;
        }
        .highlight{
            background-color: rgb(255,243,212);
        }
    </style>
</head>
<body>
<!--header-->
<div class="headerbox">
    <div class="headertop">
        <div class="hdtopbut">
            <a href="http://blog.hungking.cc/" target="_blank"><img src="imgs/sns_blog_off.png"></a>
            <a href="https://www.facebook.com/HoungkingHsi" target="_blank"><img src="imgs/sns_facebook_off.png"></a>
            <a href="http://globalblog.hungking.cc/" target="_blank"><img src="imgs/sns_gBlog_off.png"></a>
            <a href="http://www.linkedin.com/imisslovelove" target="_blank"><img src="imgs/sns_in_off.png"></a>
            <a href="http://www.youtube.com/imisslovelove" target="_blank"><img src="imgs/sns_youTube_off.png"></a>
            <a href="http://www.instagram.com/imisslovelove" target="_blank"><img src="imgs/sns_instagram_off.png"></a>
            <a href="http://story.kakao.com/ch/imisslovelove" target="_blank" style="background: transparent none;"><img src="imgs/sns_kakao_off.png"></a>
            <div class="hdtopbutR">
                <a href="construction.html" style="background-position-x:85px ;">Contact Me</a>
                <a href="construction.html">AboutSite</a>
                <span onclick="ifshow(0)">Language<img src="imgs/btn_globalSite_open.gif"></span>
                <ul id="lag">
                    <li>KOREAN</li><li>CHINESE</li><li>JAPANESE</li>
                </ul>
            </div>
        </div>
    </div>
    <div class="headerbotm">
        <a class="logohome" href="http://www.hungking.cc/company"><img src="imgs/blog.png"></a>
        <ul id="hdbotmUl">
            <li>
                <a href="company.html">WEB前端</a>
                <ul class="ultext1">
                    <li>
                        <a href="">HTML</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Corporate Overview</a></li>
                                <li><a href="">Vision of houngking</a></li>
                                <li><a href="">History of houngking</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">CSS/CSS3</a>
                        <div class="ultext2">
                            <ul>
                                <li><a>Brand Story</a></li>
                                <li><a>CI</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">JavaScript</a>
                        <div class="ultext2">
                            <ul>
                                <li><a>Greetings</a></li>
                                <li><a>CEO's Message</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Ajax</a>
                        <div class="ultext2">
                            <ul>
                                <li><a>hougking Affiliates</a></li>
                                <li><a>Steel</a></li>
                                <li><a>E&C</a></li>
                                <li><a>Trade</a></li>
                                <li><a>ICT</a></li>
                                <li><a>Energy</a></li>
                                <li><a>Material-Chemistry</a></li>
                                <li><a>Support</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">jQuery</a>
                        <div class="ultext2">
                            <ul>
                                <li><a>Global</a></li>
                                <li><a>Asia</a></li>
                                <li><a>America</a></li>
                                <li><a>Europe&Africa</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
            <li>
                <a href="company.html">Business Ethics</a>
                <ul class="ultext1">
                    <li>
                        <a href="">Code of Ethics</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">CEO Message</a></li>
                                <li><a href="">Ethics Charter</a></li>
                                <li><a href="">Practice Guidelines</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Major Activities</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Operation of the Ethical Management System</a></li>
                                <li><a href="">Education on Corporate Ethics</a></li>
                                <li><a href="">Unethical Act Prevention System</a></li>
                                <li><a href="">External Activities and Results</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
            <li>
                <a href="company.html">Products/Technology</a>
                <ul class="ultext1">
                    <li>
                        <a href="">Products of hounking</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Hot Rolled Steel</a></li>
                                <li><a href="">Steel Plate</a></li>
                                <li><a href="">Winter Day</a></li>
                                <li><a href="">Gold Rolled Steel</a></li>
                                <li><a href="">Galvanized Steel</a></li>
                                <li><a href="">Electrical Galvanized</a></li>
                                <li><a href="">Electrical Steel</a></li>
                                <li><a href="">Automotive materials</a></li>
                                <li><a href="">Stainless Steel</a></li>
                                <li><a href="">Titanium Product</a></li>
                                <li><a href="">Magnesium Product</a></li>
                                <li><a href="">Aluminum-plated products</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">houngking Technology</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">FINEX Technology</a></li>
                                <li><a href="">Strip Casting</a></li>
                                <li><a href="">Endless Hot Rolling Technology</a></li>
                                <li><a href="">Operation Technology</a></li>
                                <li><a href="">CEM Technology</a></li>
                            </ul>
                        </div>
                    </li>
                    <li style="background-image: none;">
                        <a href="">Production Process</a>
                    </li>
                    <li>
                        <a href="">Sales information</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">e-Sales</a></li>
                                <li><a href="">e-Procurement</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
            <li>
                <a href="company.html">Investor Relations</a>
                <ul class="ultext1">
                    <li style="background-image: none;">
                        <a href="">IR Activeties</a>
                    </li>
                    <li>
                        <a href="">Stock Information</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Stock Price</a></li>
                                <li><a href="">Price Comparision</a></li>
                                <li><a href="">ADR</a></li>
                                <li><a href="">houngking Stock Exchange</a></li>
                                <li><a href="">Economic Trend</a></li>
                                <li><a href="">Shareholders Demographics</a></li>
                                <li><a href="">Dividend</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Financial Information</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Income Statement</a></li>
                                <li><a href="">Credit Rating</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">IR Archive</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Audit Report</a></li>
                                <li><a href="">Form 20-F</a></li>
                                <li><a href="">Annual Report</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
            <li>
                <a href="company.html">Sustainability</a>
                <ul class="ultext1">
                    <li>
                        <a href="">Sustainability Management System</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Sustainability Management System</a></li>
                                <li><a href="">houngking Subsidiaries CSR Assessment</a></li>
                                <li><a href="">Risk Management</a></li>
                                <li><a href="">Stakeholder</a></li>
                                <li><a href="">Relevant Institutes Activities</a></li>
                            </ul>
                        </div>
                    </li>
                    <li style="background-image: none;">
                        <a href="">Social Responsibility </a>
                    </li>
                    <li>
                        <a href="">Environmental Management </a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Family's Environmental Management</a></li>
                                <li><a href="">Environmental Management</a></li>
                                <li><a href="">Climate change /Energy</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Customer</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Marketing strategy</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Employee</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Employee Health / Safety</a></li>
                                <li><a href="">Organizational Culture</a></li>
                                <li><a href="">HR system</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Report</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Sustainability Report</a></li>
                                <li><a href="">Carbon Report</a></li>
                                <li><a href="">Conflict Minerals Disclosure</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
            <li>
                <a href="company.html">PR Room</a>
                <ul class="ultext1">
                    <li style="background-image: none;">
                        <a href="">News room</a>
                    </li>
                    <li style="background-image: none;">
                        <a href="">News letter</a>
                    </li>
                    <li style="background-image: none;">
                        <a href="">houngking SNS</a>
                    </li>
                    <li>
                        <a href="">PR Archives</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Digital Brochure</a></li>
                                <li><a href="">TV Cormmercials</a></li>
                                <li><a href="">Screen Saver</a></li>
                                <li><a href="">PR Movies</a></li>
                                <li><a href="">Printed Advertisement</a></li>
                            </ul>
                        </div>
                    </li>
                    <li>
                        <a href="">Download</a>
                        <div class="ultext2">
                            <ul>
                                <li><a href="">Company</a></li>
                                <li><a href="">Products/Technology</a></li>
                                <li><a href="">Investor Relations</a></li>
                                <li><a href="">Sustainability</a></li>
                                <li><a href="">PR Room</a></li>
                            </ul>
                        </div>
                    </li>
                </ul>
            </li>
        </ul>
        <img src="imgs/btn_gnb.png" class="imgbtn" id="imgbtn" onclick="ifshow(1)">
        <img src="imgs/btn_search.png" class="imgbtn2" onclick="ifshow(2)">
        <div class="hdmenu" id="hdmenu">
            <a href="">Open submenu</a>
            <ul class="menutxt1">
                <li>
                    <a href="">Company</a>
                    <ul>
                        <li><a href="">Corporate Overview</a></li>
                        <li><a href="">Brand</a></li>
                        <li><a href="">CEO</a></li>
                        <li><a href="">hounking Affiliates</a></li>
                        <li><a href="">hounking Overseas</a></li>
                    </ul>
                </li>
                <li>
                    <a href="">Business Ethics</a>
                    <ul>
                        <li><a href="">Code of Ethics</a></li>
                        <li><a href="">Major Activities</a></li>
                    </ul>
                </li>
                <li>
                    <a href="">Products/Technology</a>
                    <ul>
                        <li><a href="">Products of houngking</a></li>
                        <li><a href="">hounking Technology</a></li>
                        <li><a href="">Production Process</a></li>
                        <li><a href="">Sales informtion</a></li>
                    </ul>
                </li>
                <li style="padding: 0px;">
                    <a href="">Investor Relations</a>
                    <ul>
                        <li><a href="">IR Activities</a></li>
                        <li><a href="">Stock Information</a></li>
                        <li><a href="">Financial Information</a></li>
                        <li><a href="">IR Archive</a></li>
                    </ul>
                </li>
                <li>
                    <a href="">Sustainability</a>
                    <ul>
                        <li><a href="">Suatainability Management System</a></li>
                        <li><a href="">Social Redponsibility</a></li>
                        <li><a href="">Environmental Management</a></li>
                        <li><a href="">Customer</a></li>
                        <li><a href="">Employee</a></li>
                        <li><a href="">Report</a></li>
                    </ul>
                </li>
                <li>
                    <a href="">PR Room</a>
                    <ul>
                        <li><a href="">Newsroom</a></li>
                        <li><a href="">Newsletter</a></li>
                        <li><a href="">houngking SNS</a></li>
                        <li><a href="">PR Archives</a></li>
                        <li><a href="">Download</a></li>
                    </ul>
                </li>
                <li>
                    <a href="">Contact Us</a>
                    <ul>
                        <li><a href="">Q&A</a></li>
                        <li><a href="">Search</a></li>
                        <li><a href="">Location</a></li>
                        <li><a href="">Sitemap</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</div>
<!--text-->
<div class="textBox">
    <h2>使用 Fetch & Fetch API</h2>
    <h3>1,使用 Fetch</h3>
    <p>fetch规范与jQuery.ajax()主要有两种方式的不同，牢记：</p>
    <p>· 当接收到一个代表错误的 HTTP 状态码时，从 fetch()返回的 Promise 不会被标记为 reject， 即使该 HTTP 响应的状态码是 404 或 500。相反，它会将 Promise 状态标记为 resolve （但是会将 resolve 的返回值的 ok 属性设置为 false ），仅当网络故障时或请求被阻止时，才会标记为 reject。</p>
    <p>所以一般会对fetch请求做一层封装，例如下面代码所示：</p>
    <pre style="height: 200px;">
function checkStatus(response) {
  if (response.status >= 200 && response.status < 300) {
    return response;
  }
  const error = new Error(response.statusText);
  error.response = response;
  throw error;
}
function parseJSON(response) {
  return response.json();
}
export default function request(url, options) {
  let opt = options||{};
  return fetch(url, {credentials: 'include', ...opt})
    .then(checkStatus)
    .then(parseJSON)
    .then((data) => ( data ))
    .catch((err) => ( err ));
}   </pre>
    <p>· 默认情况下，fetch 不会从服务端发送或接收任何 cookies, 如果站点依赖于用户 session，则会导致未经认证的请求（要发送 cookies，必须设置 credentials 选项）。</p>
    <h4>进行 fetch 请求 :</h4>
    <p>一个基本的 fetch请求设置起来很简单。fetch() 接受第二个可选参数，一个可以控制不同配置的 init 对象:</p>
    <pre>
fetch(url, {
    body: JSON.stringify(data), // must match 'Content-Type' header
    cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
    credentials: 'same-origin', // include, same-origin, *omit
    headers: {
      'user-agent': 'Mozilla/4.0 MDN Example',
      'content-type': 'application/json'
    },
    method: 'POST', // *GET, POST, PUT, DELETE, etc.
    mode: 'cors', // no-cors, cors, *same-origin
    redirect: 'follow', // manual, *follow, error
    referrer: 'no-referrer', // *client, no-referrer
  })
  .then(response => response.json()) // parses response to JSON
  .then(function(myJson) {
    console.log(myJson);
  });</pre>
    <h4>发送带凭据的请求:</h4>
    <p>为了让浏览器发送包含凭据的请求（即使是跨域源），要将credentials: 'include'添加到传递给 fetch()方法的init对象。</p>
    <pre>
fetch('https://example.com', {
  credentials: 'include'
})</pre>
    <p>如果你只想在请求URL与调用脚本位于同一起源处时发送凭据，请添加credentials: 'same-origin'。</p>
    <pre>
// The calling script is on the origin 'https://example.com'

fetch('https://example.com', {
  credentials: 'same-origin'
})</pre>
    <p>要改为确保浏览器不在请求中包含凭据，请使用credentials: 'omit'。</p>
    <pre>
fetch('https://example.com', {
  credentials: 'omit'
}) </pre>
    <h4>上传文件:</h4>
    <p>Files can be uploaded using an HTML &lt;input type="file" /&gt; input element,<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FormData/FormData" target="_blank"> FormData()</a> and fetch().</p>
    <pre>
var formData = new FormData();
var fileField = document.querySelector("input[type='file']");

formData.append('username', 'abc123');
formData.append('avatar', fileField.files[0]);

fetch('https://example.com/profile/avatar', {
  method: 'PUT',
  body: formData
})
.then(response => response.json())
.then(response => console.log('Success:', response));</pre>
    <h4>自定义请求对象:</h4>
    <p>除了传给 fetch() 一个资源的地址，你还可以通过使用 Request() 构造函数来创建一个 request 对象，然后再作为参数传给 fetch()：</p>
    <pre>
var myRequest = new Request('flowers.jpg', { method: 'GET',
               headers: new Headers(),
               mode: 'cors',
               cache: 'default' });

fetch(myRequest).then(function(response) {
  return response.blob();
}).then(function(myBlob) {
  var objectURL = URL.createObjectURL(myBlob);
  myImage.src = objectURL;
});</pre>
    <h3>2,Headers</h3>
    <p>使用 Headers 的接口，你可以通过 Headers() 构造函数来创建一个你自己的 headers 对象。一个 headers 对象是一个简单的多名值对：</p>
    <pre>
var content = "Hello World";
var myHeaders = new Headers();
myHeaders.append("Content-Type", "text/plain");
myHeaders.append("Content-Length", content.length.toString());</pre>
    <p>也可以传一个多维数组或者对象字面量.</p>
    <p>它的内容可以被获取：</p>
    <pre>
console.log(myHeaders.has("Content-Type")); // true
console.log(myHeaders.get("Content-Length")); // 11</pre>
    <p>虽然一些操作只能在 ServiceWorkers 中使用，但是它提供了更方便的操作 Headers 的 API。</p>
    <p>如果使用了一个不合法的HTTP Header属性名，那么Headers的方法通常都抛出 TypeError 异常。如果不小心写入了一个不可写的属性，也会抛出一个 TypeError 异常。除此以外的情况，失败了并不抛出异常。</p>
    <h4>Guard:</h4>
    <p>由于 Headers 可以在 request 请求中被发送或者在 response 请求中被接收，并且规定了哪些参数是可写的，Headers 对象有一个特殊的 guard 属性。这个属性没有暴露给 Web，但是它影响到哪些内容可以在 Headers 对象中被操作。</p>
    <h3>3,Body</h3>
    <p>不管是请求还是响应都能够包含body对象. body也可以是以下任意类型的实例.</p>
    <p>· ArrayBuffer</p>
    <p>· ArrayBufferView (Uint8Array and friends)</p>
    <p>· Blob/File</p>
    <p>· string</p>
    <p>· URLSearchParams</p>
    <p>· FormData</p>
    <p>Body 类定义了以下方法 (这些方法都被 Request 和Response所实现)以获取body内容. 这些方法都会返回一个被解析后的promise对象和数据.</p>
    <p>· arrayBuffer()</p>
    <p>· blob()</p>
    <p>· json()</p>
    <p>· text()</p>
    <p>· formData()</p>
    <p>请求体可以由传入body参数来进行设置:</p>
    <pre>
var form = new FormData(document.getElementById('login-form'));
fetch("/login", {
  method: "POST",
  body: form
})</pre>
    <p>request和response（包括fetch() 方法）都会试着自动设置Content-Type。如果没有设置Content-Type值，发送的请求也会自动设值。</p>

    <h3>4,Fetch API</h3>
    <p>Fetch API 提供了一个获取资源的接口（包括跨域）。它提供了一个全局 fetch()方法，该方法提供了一种简单，合理的方式来跨网络异步获取资源。</p>
    <p>你也可以通过 Request() 和 Response() 的构造函数直接创建请求和响应，但是我们不建议这么做。他们应该被用于创建其他 API 的结果（比如，service workers 中的 FetchEvent.respondWith）。</p>
    <h3>5,fetch使用的常见问题及解决办法</h3>
    <p>fetch所带来的优点:</p>
    <p>· 语法简单，更加语义化</p>
    <p>· 基于标准的Promise实现，支持async/await</p>
    <p>· 使用isomorphic-fetch可以方便同构</p>
    <h4>fetch兼容性:</h4>
    <p>大多数情况下，实现fetch的polyfill需要涉及到的：</p>
    <p>· promise的polyfill，例如es6-promise、babel-polyfill提供的promise实现。</p>
    <p>· fetch的polyfill实现，例如isomorphic-fetch和whatwg-fetch</p>
    <p>上面说了在大多数情况下是这样，但是IE8/9则比较特殊：IE8它使用的是ES3，而IE9则对ES5部分支持。这种情况下还需要ES5的polyfill es5-shim支持了。</p>
    <p>上述有关promise的polyfill实现，需要说明的是：</p>
    <p class="highlight">babel-runtime是不能作为Promise的polyfill的实现的，否则在IE8/9下使用fetch会报Promise未定义。为什么？我想大家猜到了，因为babel-runtime实现的polyfill是局部实现而不是全局实现，fetch底层实现用到Promise就是从全局中去取的，拿不到这报上述错误。</p>
    <p>另外，顺便补充一下fetch的polyfill实现思路是：</p>
    <p class="highlight">首先判断浏览器是否原生支持fetch，否则结合Promise使用XMLHttpRequest的方式来实现；这正是whatwg-fetch的实现思路，而同构应用中使用的isomorphic-fetch，其客户端fetch的实现是直接require whatwg-fetch来实现的。</p>
    <h4>fetch不支持超时timeout处理:</h4>
    <p>用过fetch的都知道，fetch不像大多数ajax库那样对请求设置超时timeout，它没有有关请求超时的feature，这一点比较蛋疼。所以在fetch标准添加超时feature之前，都需要polyfill该特性。</p>
    <p>实际上，我们真正需要的是abort()， timeout可以通过timeout+abort方式来实现，起到真正超时丢弃当前的请求。</p>
    <p>而在目前的fetch指导规范中，fetch并不是一个具体实例，而只是一个方法；其返回的promise实例根据Promise指导规范标准是不能abort的，也不能手动改变promise实例的状态，只能由内部来根据请求结果来改变promise的状态。</p>
    <p>既然不能手动控制fetch方法执行后返回的promise实例状态，那么是不是可以创建一个可以手动控制状态的新Promise实例呢。所以：</p>
    <p class="highlight">实现fetch的timeout功能，其思想就是新创建一个可以手动控制promise状态的实例，根据不同情况来对新promise实例进行resolve或者reject，从而达到实现timeout的功能；</p>
    <p>根据github上timeout handling上的讨论，目前可以有两种不同的解决方法：</p>
    <h5>方法一：单纯setTimeout方式</h5>
    <pre>
var oldFetchfn = fetch; //拦截原始的fetch方法
window.fetch = function(input, opts){//定义新的fetch方法，封装原有的fetch方法
    return new Promise(function(resolve, reject){
        var timeoutId = setTimeout(function(){
            reject(new Error("fetch timeout"))
        }, opts.timeout);
        oldFetchfn(input, opts).then(
            res=>{
                clearTimeout(timeoutId);
                resolve(res)
            },
            err=>{
                clearTimeout(timeoutId);
                reject(err)
            }
        )
    })
}</pre>
    <p>当然在上面基础上可以模拟类似XHR的abort功能：</p>
    <pre>
var oldFetchfn = fetch;
window.fetch = function(input, opts){
    return new Promise(function(resolve, reject){
        var abort_promise = function(){
            reject(new Error("fetch abort"))
        };
        var p = oldFetchfn(input, opts).then(resolve, reject);
        p.abort = abort_promise;
        return p;
    })
}   </pre>
    <h5>方法二：利用Promise.race方法</h5>
    <pre>
var oldFetchfn = fetch; //拦截原始的fetch方法
window.fetch = function(input, opts){//定义新的fetch方法，封装原有的fetch方法
    var fetchPromise = oldFetchfn(input, opts);
    var timeoutPromise = new Promise(function(resolve, reject){
        setTimeout(()=>{
             reject(new Error("fetch timeout"))
        }, opts.timeout)
    });
    retrun Promise.race([fetchPromise, timeoutPromise])
}  </pre>
    <p>最后，对fetch的timeout的上述实现方式补充几点：</p>
    <p class="highlight">timeout不是请求连接超时的含义，它表示请求的response时间，包括请求的连接、服务器处理及服务器响应回来的时间；
        fetch的timeout即使超时发生了，本次请求也不会被abort丢弃掉，它在后台仍然会发送到服务器端，只是本次请求的响应内容被丢弃而已；</p>
    <h4>fetch不支持JSONP:</h4>
    <p>fetch是与服务器端进行异步交互的，而 <span class="highlight">JSONP是外链一个javascript资源，并不是真正ajax</span>，所以fetch与JSONP没有什么直接关联，当然至少目前是不支持JSONP的。</p>
    <p>这里我们把JSONP与fetch关联在一起有点差强人意，fetch只是一个ajax库，我们不可能使fetch支持JSONP；只是我们要实现一个JSONP，只不过这个JSONP的实现要与fetch的实现类似，即基于Promise来实现一个JSONP；而其外在表现给人感觉是fetch支持JSONP一样；</p>
    <p>目前比较成熟的开源JSONP实现fetch-jsonp给我们提供了解决方案，想了解可以自行前往。使用它非常简单，首先需要用npm安装fetch-jsonp</p>
    <p>然后在像下面一样使用：</p>
    <pre>
fetchJsonp('/users.jsonp', {
    timeout: 3000,
    jsonpCallback: 'custom_callback'
  })
  .then(function(response) {
    return response.json()
  }).catch(function(ex) {
    console.log('parsing failed', ex)
}) </pre>
    <h4>fetch不支持progress事件:</h4>
    <p>XHR是原生支持progress事件的，例如下面代码这样：</p>
    <pre>
var xhr = new XMLHttpRequest()
xhr.open('POST', '/uploads')
xhr.onload = function() {}
xhr.onerror = function() {}
function updateProgress (event) {
  if (event.lengthComputable) {
    var percent = Math.round((event.loaded / event.total) * 100)
    console.log(percent)
  }
xhr.upload.onprogress =updateProgress; //上传的progress事件
xhr.onprogress = updateProgress; //下载的progress事件
}
xhr.send();  </pre>
    <p>但是fetch是不支持有关progress事件的；不过可喜的是，根据fetch的指导规范标准，其内部设计实现了Request和Response类；其中Response封装一些方法和属性，通过Response实例可以访问这些方法和属性，例如response.json()、response.body等等；</p>
    <p>值得关注的地方是，response.body是一个可读字节流对象，其实现了一个getRender()方法，其具体作用是：</p>
    <p class="highlight">getRender()方法用于读取响应的原始字节流，该字节流是可以循环读取的，直至body内容传输完成；</p>
    <p>因此，利用到这点可以模拟出fetch的progress，具体可以参考这篇文章
        <a href="https://jakearchibald.com/2016/streams-ftw/" target="_blank">2016 - the year of web streams</a> 。</p>
    <p>代码实现如下，在线demo请参考fetch progress demo。</p>
    <pre style="height: 200px;">
// fetch() returns a promise that resolves once headers have been received
fetch(url).then(response => {
  // response.body is a readable stream.
  // Calling getReader() gives us exclusive access to the stream's content
  var reader = response.body.getReader();
  var bytesReceived = 0;

  // read() returns a promise that resolves when a value has been received
  reader.read().then(function processResult(result) {
    // Result objects contain two properties:
    // done  - true if the stream has already given you all its data.
    // value - some data. Always undefined when done is true.
    if (result.done) {
      console.log("Fetch complete");
      return;
    }

    // result.value for fetch streams is a Uint8Array
    bytesReceived += result.value.length;
    console.log('Received', bytesReceived, 'bytes of data so far');

    // Read some more, and call this function again
    return reader.read().then(processResult);
  });
});  </pre>
    <p>另外，github上也有使用Promise+XHR结合的方式实现类fetch的progress效果(当然这跟fetch完全不搭边）可以参考
        <a href="https://github.com/github/fetch/issues/89" target="_blank">这里</a>，具体代码如下：</p>
    <pre style="height: 200px;">
function fetchProgress(url, opts={}, onProgress){
    return new Promise(funciton(resolve, reject){
        var xhr = new XMLHttpRequest();
        xhr.open(opts.method || 'get', url);
        for(var key in opts.headers || {}){
            xhr.setRequestHeader(key, opts.headers[key]);
        }

        xhr.onload = e => resolve(e.target.responseText)
        xhr.onerror = reject;
        if (xhr.upload && onProgress){
            xhr.upload.onprogress = onProgress; //上传
        }
        if ('onprogerss' in xhr && onProgress){
            xhr.onprogress = onProgress; //下载
        }
        xhr.send(opts.body)
    })
}
fetchProgress('/upload').then(console.log)  </pre>
    <h4>fetch跨域问题:</h4>
    <p>既然是ajax库，就不可避免与跨域扯上关系；XHR2是支持跨域请求的，只不过要满足浏览器端支持CORS，服务器通过Access-Control-Allow-Origin来允许指定的源进行跨域，仅此一种方式。</p>
    <p>与XHR2一样，fetch也是支持跨域请求的，只不过其跨域请求做法与XHR2一样，需要客户端与服务端支持；另外，fetch还支持一种跨域，不需要服务器支持的形式，具体可以通过其mode的配置项来说明。</p>
    <p>fetch的mode配置项有3个值，如下：</p>
    <p>· same-origin：该模式是不允许跨域的，它需要遵守同源策略，否则浏览器会返回一个error告知不能跨域；其对应的response type为basic。</p>
    <p>· cors: 该模式支持跨域请求，顾名思义它是以CORS的形式跨域；当然该模式也可以同域请求不需要后端额外的CORS支持；其对应的response type为cors。</p>
    <p>· no-cors: 该模式用于跨域请求但是服务器不带CORS响应头，也就是服务端不支持CORS；这也是fetch的特殊跨域请求方式；其对应的response type为opaque。</p>
    <p>针对跨域请求，cors模式是常见跨域请求实现，但是fetch自带的no-cors跨域请求模式则较为陌生，该模式有一个比较明显的特点：</p>
    <p class="highlight">该模式允许浏览器发送本次跨域请求，但是不能访问响应返回的内容，这也是其response type为opaque透明的原因。</p>
    <p>这与&lt;img/&gt;发送的请求类似，只是该模式不能访问响应的内容信息；但是它可以被其他APIs进行处理，例如ServiceWorker。另外，该模式返回的repsonse可以在Cache API中被存储起来以便后续的对它的使用，这点对script、css和图片的CDN资源是非常合适的，因为这些资源响应头中都没有CORS头。</p>
    <p>总的来说，fetch的跨域请求是使用CORS方式，需要浏览器和服务端的支持。</p>
    <h3>6, fetch的请求拦截实现</h3>
    <h4>Fetch请求如何拦截后面的then :</h4>
    <p>在做项目的时候，为了统一处理，需要封装一个fetch,假设如下：</p>
    <pre style="height: 150px;">
function myFetch(url){
    return fetch(url)
    .then(res => {
        if(res.ok){
            return res.json()
        }else{
            throw "network error";
        }
    })
    .then( json => {
        if(json.ret === true){
             return json.data;
        }else{
             throw "request error";
        }
    })
    .catch( err => console.log(err) )
}</pre>
    <p>然后，如果我使用myFetch的时候请求报错的话：</p>
    <pre>
myFetch('http://error.com')//这是一个对触发请求错误的地址
    .then( data => {
        console.log(data);  //对数据做处理
    })</pre>
    <p>预想是：请求触发了一个错误，被catch捕抓了，整个fetch结束；但是，真实情况是：我做数据处理的then位于catch后面，所以then依然在继续执行，但实际上参数 data没有任何值（因为上一步没有return值），这样又会报错。</p>
    <p>所以如何使这个myFetch可以捕抓所有fetch里面的错误，并且发生catch后，不让后面的then执行？</p>
    <p>先分析一下错误捕获的逻辑：</p>
    <p class="highlight">· 对于没有服务器响应的地址，fetch 不执行 then，而直接跳到 catch 里，并不会抛出错误 “network error”；</p>
    <p class="highlight">· 对于服务器返回的 404 等错误，res.ok 是 false，会抛出 “network error”，然后也是跳到 catch 里执行；</p>
    <p>上面有问题的使用方式中，最终 then 是直接接在 myFetch 里 fetch catch 后面，而 catch 有没有返回值，所以后面的 then 只能取到 undefined。对于这种情况，只要在 myFetch 的 fetch catch 里继续抛出异常即可，代码如下：</p>
    <pre>
function myFetch(url) {
  return fetch(url).then(res => {
    if (res.ok) {
      return res.json();
    } else {
      throw `${res.status}, ${res.statusText}`;
    }
  })
  .then(json => {
    return json;
  })
  .catch(err => {
    throw err;
  });
}  </pre>
    <p>调用 myFetch 代码:</p>
    <pre>
meFetch(url)
.then((data) => {
  // 处理正确返回的数据
})
.catch((error) => {
  // 处理错误
});  </pre>
    <p>也可以用 Promise 包装下 fetch，代码看起来可能更简单点：</p>
    <pre style="height: 150px;">
function myFetch(url) {
  return new Promise((resolve, reject) => {
    fetch(url).then(res => {
      if (res.ok) {
        return res.json();
      } else {
        throw `${res.status}, ${res.statusText}`;
      }
    })
    .then(json => {
      resolve(json);
    })
    .catch(err => {
      reject(err);
    });
  });
}  </pre>
    <p>最后附上自己封装的一个网络请求request.js:</p>
    <pre style="height: 500px;">
/**
 * 该方法仅支持IE8以上
* 网络请求方法
* url：请求地址
* options = {
* 	catchs: 异常处理，控制台抛出的异常是否自己处理：true 是，false 否 由公共方法统一处理优化显示给用户 默认 false
* 	credentials: 请求带上cookies，是每次请求保持会话一直
* 	method: 请求使用的方法，如 GET、POST
* 	headers: 请求的头信息，形式为 Headers 对象或 ByteString。
* 	body: 请求的 body 信息：可能是一个 Blob、BufferSource、FormData、URLSearchParams 或者 USVString 对象。注意 GET 或 HEAD 方法的请求不能包含 body 信息。
* 	mode: 请求的模式，如 cors、no-cors 或者same-origin。是否允许跨域请求
* 	cache:  请求的 cache 模式: default, no-store, reload, no-cache, force-cache, or only-if-cached.
* }
*/

var $requst = function (url, options) {
	var myHeaders = {
		'Content-Type': 'text/html; charset=utf-8'
	};
	var init = {
		credentials: 'include',
		method: (options && options.method) || 'GET',
        headers: (options && options.headers) || myHeaders,
        cache: (options && options.cache) || 'default'
	}
	if (options && options.body) {
		init.body = JSON.stringify(options.body)
	}
	return fetch(url, init)
	  .then(function(response) {
		  if (response.ok) {
			  return _returnContentByType(response);
		  } else {
			  if (options && options.catchs) {
				  throw new Error(response.statusText);
			  } else {
				  var error = new Error(response.statusText);
				  throw new Error('');
			  }
		  }
	  });
};

/**
 * 根据type返回不同格式的response
 */
var _returnContentByType = function (response) {
	var type = response.headers.get('Content-Type').split(";")[0];
	switch (type) {
        case 'text/html':
        	return response.text();
        	break
        case 'application/json':
        	return response.json();
        	break
        default:
	}
};</pre>

    <br/>
    <h5>参考文档:</h5>
    <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API/Using_Fetch" target="_blank">使用 Fetch(MDN)</a>,<br>
    <a href="https://www.cnblogs.com/wonyun/p/fetch_polyfill_timeout_jsonp_cookie_progress.html" target="_blank">fetch使用的常见问题及解决办法</a>,<br>
    <a href="https://cn.eslint.org/docs/rules/no-throw-literal" target="_blank">ESLint限制可以被抛出的异常 (no-throw-literal)</a>,<br>
    <a href="http://react-china.org/t/fetch-then/7054/3" target="_blank">Fetch请求如何拦截后面的then</a>,<br>
    <a href="https://www.jianshu.com/p/65f03b0b1b6b" target="_blank">fetch拦截器的实现</a>,<br>
    <a href="https://github.com/swissquote/fetch-filter" target="_blank">github fetch-filter</a>,<br>
    <a href="https://www.cnblogs.com/cloud-/p/7305857.html" target="_blank">whatwg-fetch源码分析</a>,<br>
</div>

</body>
</html>